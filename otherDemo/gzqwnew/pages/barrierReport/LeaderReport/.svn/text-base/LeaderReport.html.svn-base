<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>动态勤务管理云应用</title>

		<link rel="stylesheet" type="text/css" href="../../../plugins/layer/theme/default/layer.css" />
		<!-- Bootstrap 3.3.7 -->
		<link rel="stylesheet" type="text/css" href="../../../plugins/bootstrap/css/bootstrap.min.css" />
		<!-- Font Awesome -->
		<link rel="stylesheet" type="text/css" href="../../../plugins/font_awesome/css/font-awesome.min.css" />
		<!-- Ionicons -->
		<link rel="stylesheet" type="text/css" href="../../../plugins/ionicons/css/ionicons.min.css" />
		<!-- AdminLTE -->
		<link rel="stylesheet" type="text/css" href="../../../plugins/AdminLTE/css/AdminLTE.css" />
		<!-- AdminLTE skin -->
		<link rel="stylesheet" type="text/css" href="../../../plugins/AdminLTE/css/skins/_all-skins.min.css" />
		<!-- general -->
		<link rel="stylesheet" type="text/css" href="../../../css/general.css" />
		<!-- fullCalendar -->
		<link rel="stylesheet" href="../../../plugins/fullcalendar/fullcalendar.min.css">
		<link rel="stylesheet" href="../../../plugins/fullcalendar/fullcalendar.print.css" media="print">
		<!-- ReportCSS -->
		<link rel="stylesheet" type="text/css" href="../../../css/barrierReport/barrierReport.css" />
		
		<style>
			.report-table th {
				width: 12.5%;
			}
			.selected {
				background-color: #C4E3F3;
			}
		</style>
	</head>

	<body class="innerPage">
		<div>
			<section class="content-header">
				<h1>
					岗位报备
					<small>值班领导报备</small>
				</h1>
				<ol class="breadcrumb">
					<li>
						<a href="#"><i class="fa fa-dashboard"></i> 首页</a>
					</li>
					<li>
						<a href="#">岗位报备</a>
					</li>

					<li class="active">值班领导报备</li>
				</ol>
			</section>

			<!-- Main content -->
			<section class="content">
				<div class="row">
					<div class="col-md-2">
						<div class="box box-primary">
							<div class="box-header with-border">
								<h3 class="box-title">选择人员</h3>
							</div>
							<div class="box-body">
								<div>
									<label>人员所属单位</label>
									<input type="text" id="objectUnit" value="广州市公安局" />
									<label>搜索</label>
									<div class="input-group ">
										<input type="text" class="form-control" placeholder="请输入搜索名称">
										<span class="input-group-btn">
											<button type="button" class="btn btn-info btn-flat">搜索</button>
										</span>
									</div>
								</div>
								<br>
								<div class="report-policeContainer">
									<div class="report-police bg-green peopleItem" title="男 年长">
										<span class="name">张三</span>
									</div>
									<div class="report-police bg-yellow peopleItem">
										<span class="name">李四</span>
									</div>
									<div class="report-police bg-aqua peopleItem">
										<span class="name">王五</span>
									</div>
									<div class="report-police bg-aqua peopleItem">
										<span class="name">赵六</span>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="col-md-10">
						<div class="box box-primary" id="reportBox">
							<div id="week-header" class="box-header with-border">
								<h3 class="box-title">报备</h3>
								<button class="btn btn-success pull-right" style="margin: 0 5px;" onclick="onSaveBaoBeiButtonClickHandler(this)">保存报备</button>
								<button class="btn btn-primary pull-right" style="margin: 0 5px;" onclick="onMultiBaoBeiButtonClickHandler(this)">批量报备</button>
								<button class="btn btn-default pull-right" style="margin: 0 60px 0 5px;" onclick="nextWeek()">下一周</button>
								<button class="btn btn-default pull-right" style="margin: 0 5px;" onclick="prevWeek()">上一周</button>
							</div>
							<div id="month-header" class="box-header with-border" style="display: none;">
								<h3 class="box-title">报备</h3>
								<button class="btn btn-success pull-right" style="margin: 0 5px;" onclick="onSaveBaoBeiButtonClickHandler(this)">保存报备</button>
								<button class="btn btn-primary pull-right" style="margin: 0 5px;" onclick="onBacktoBaoBeiButtonClickHandler(this)">返回</button>
								
							</div>
							<div class="box-body" id="week-container">
								<table class="report-table">
									<tr>
										<th></th>
										<th class="headerDate">
											10月23日&nbsp;周一
										</th>
										<th class="headerDate">
											10月24日&nbsp;周二
										</th>
										<th class="headerDate">
											10月25日&nbsp;周三
										</th>
										<th class="headerDate">
											10月26日&nbsp;周四
										</th>
										<th class="headerDate">
											10月27日&nbsp;周五
										</th>
										<th class="headerDate">
											10月28日&nbsp;周六
										</th>
										<th class="headerDate">
											10月29日&nbsp;周日
										</th>
									</tr>
									<tr class="report-duty">
										<th>值班领导岗位</th>
										<td class="report-table-policeContainer">
											<div class="leaderContainer"></div>
											<div class="directorContainer"></div>
										</td>
										<td class="report-table-policeContainer">
											<div class="leaderContainer"></div>
											<div class="directorContainer"></div>
										</td>
										<td class="report-table-policeContainer">
											<div class="leaderContainer"></div>
											<div class="directorContainer"></div>
										</td>
										<td class="report-table-policeContainer">
											<div class="leaderContainer"></div>
											<div class="directorContainer"></div>
										</td>
										<td class="report-table-policeContainer">
											<div class="leaderContainer"></div>
											<div class="directorContainer"></div>
										</td>
										<td class="report-table-policeContainer">
											<div class="leaderContainer"></div>
											<div class="directorContainer"></div>
										</td>
										<td class="report-table-policeContainer">
											<div class="leaderContainer"></div>
											<div class="directorContainer"></div>
										</td>
									</tr>
								</table>
							</div>
							
							<div class="box-body" id="month-container" style="display: none;">
								<div id="calendar"></div>
							</div>
						</div>
					</div>
				</div>
			</section>
			<!-- /.content -->
		</div>
		<br><br>
		<!-- /.content-wrapper -->
		<!-- jQuery -->
		<script src="../../../plugins/jquery/jquery-3.2.1.js"></script>
		<!-- Bootstrap 3.3.7 -->
		<script src="../../../plugins/bootstrap/js/bootstrap.js"></script>
		<script src="../../../plugins/layer/layer.js"></script>
		<!-- AdminLTE App -->
		<script type="text/javascript" src="../../../plugins/AdminLTE/js/adminlte.js"></script>
		<!-- utilJS -->
		<script type="text/javascript" src="../../../js/util.js"></script>
		<!-- easyUILoader -->
		<script type="text/javascript" src="../../../plugins/easyui/easyloader.js"></script>
		
		<script src="../../../plugins/fullcalendar/moment.js"></script>
		<script type="text/javascript" src="../../../plugins/fullcalendar/fullcalendar.js"></script>

		<script>
			var reportingDiv = [];
			var polices = ['张三', '李四', '王五', '赵六']
			var loadingDiv = $('<div class="overlay"><i class="fa fa-refresh fa-spin"></i></div>')

			$(document).ready(function() {
				easyloader.load('combotree', function() {
					$('#objectUnit').combotree({
						width: '100%',
						height: 33,
						data: treeData
					});

					$("#objectUnit").combotree('tree').tree("collapseAll");
				});
				easyloader.load(['draggable', 'droppable'], function() {
					$('.leaderContainer').droppable({
						onDragEnter: function(e, source) {
							$(source).draggable('options').cursor = 'auto';
						},
						onDragLeave: function(e, source) {
							$(source).draggable('options').cursor = 'not-allowed';
						},
						onDrop: function(e, source) {
							var policeName = $(source).find(".policeName").html()
							var appendDiv = $("<div class='reportedPolice'><span class='policeName'>" + policeName + "</span><i class='pull-right fa fa-remove removeButton' style='color: #FFF;'></i></div>")
							$(e.target).append(appendDiv)
							makeDraggable($(e.target).find(".reportedPolice"))
							makeDelButton($(appendDiv).find(".removeButton"))
							source.remove()
						}
					});
					$('.directorContainer').droppable({
						onDragEnter: function(e, source) {
							$(source).draggable('options').cursor = 'auto';
						},
						onDragLeave: function(e, source) {
							$(source).draggable('options').cursor = 'not-allowed';
						},
						onDrop: function(e, source) {
							var policeName = $(source).find(".policeName").html()
							var appendDiv = $("<div class='reportedPolice'><span class='policeName'>" + policeName + "</span><i class='pull-right fa fa-remove removeButton' style='color: #FFF;'></i></div>")
							$(e.target).append(appendDiv)
							makeDraggable($(e.target).find(".reportedPolice"))
							makeDelButton($(appendDiv).find(".removeButton"))
							source.remove()
						}
					});
					$(".peopleItem").tooltip();
				});
				easyloader.locale = "zh_CN";
				

				$(".peopleItem").click(function(e) {
					if(reportingDiv && reportingDiv.length>0) {
						var policeName;
						if($(e.target).find(".name").html()) {
							policeName = $(e.target).find(".name").html();
						} else {
							policeName = $(e.target).html()
						}
						reportPeople(policeName);
					}
				})

			});
			
			function bindEvents(){
				$('.leaderContainer, .directorContainer').bind("click",function() {
					if($(this).hasClass("reportingLeaderContainer")){
						reportingDiv.splice($.inArray(this, reportingDiv), 1);
						$(this).removeClass("reportingLeaderContainer");

					}else{
						reportingDiv.push(this);
						$(this).addClass("reportingLeaderContainer");
					}
				});
			}
			

			function reportPeople(policeName) {
				if(reportingDiv && reportingDiv.length>0) {
					for(var i=0; i<reportingDiv.length; i++){
						var appendDiv = $("<div class='reportedPolice'><span class='policeName'>" + policeName + "</span><i class='pull-right fa fa-remove removeButton' style='color: #FFF;'></i></div>");
						var a = $(reportingDiv[i]).append(appendDiv);
						makeDraggable(appendDiv);
						makeDelButton(appendDiv.find(".removeButton"));
					}
				}
				makeDraggable();
				makeDelButton();
				clearReportingDiv();
			}
			
			function clearReportingDiv(){
				if(reportingDiv){
					for(var j=0; j<reportingDiv.length; j++){
						var obj = $(reportingDiv[j]);
						obj.removeClass("reportingLeaderContainer");
					}
					reportingDiv = [];
				}
			}
			
			function makeDraggable(obj) {
				$(obj).draggable({
					revert: true,
					onStartDrag: function() {
						$(this).draggable('options').cursor = 'not-allowed';
						$(this).css('z-index', 999);
					},
					onStopDrag: function() {
						$(this).draggable('options').cursor = 'move';
					}
				});
			}

			function makeDelButton(obj) {
				$(obj).mousedown(function() {
					$(obj).parent().remove();
				})
			}

			/*function makeDraggable() {
				for(var i=0; i<reportingDiv.length; i++){
					var obj = $(reportingDiv[i]).find(".reportedPolice");
					$(obj).draggable({
						revert: true,
						onStartDrag: function() {
							$(this).draggable('options').cursor = 'not-allowed';
							$(this).css('z-index', 999);
						},
						onStopDrag: function() {
							$(this).draggable('options').cursor = 'move';
						}
					});
				}
			}

			function makeDelButton(obj) {
				for(var i=0; i<reportingDiv.length; i++){
					var obj = $(reportingDiv[i]).find(".removeButton");
					$(obj).mousedown(function() {
						$(obj).parent().remove();
					})
				}
				
			}*/
			
			
			function createReport() {
				var loadingDivc = loadingDiv.clone()
				$("#reportBox").append(loadingDivc);
				setTimeout(function() {
					$(".leaderContainer").each(function() {
						var ii = Math.floor(Math.random() * 4)
						var appendDiv = $("<div class='reportedPolice'><span class='policeName'>" + polices[ii] + "</span><i class='pull-right fa fa-remove removeButton' style='color: #FFF;'></i></div>")
						$(this).append(appendDiv)
						makeDraggable($(appendDiv))
						makeDelButton($(appendDiv).find(".removeButton"))
					})
					$(".directorContainer").each(function() {
						var ii = Math.floor(Math.random() * 4)
						var appendDiv = $("<div class='reportedPolice'><span class='policeName'>" + polices[ii] + "</span><i class='pull-right fa fa-remove removeButton' style='color: #FFF;'></i></div>")
						$(this).append(appendDiv)
						makeDraggable($(appendDiv))
						makeDelButton($(appendDiv).find(".removeButton"))
					})
					$("#reportBox").find(".overlay").remove()
				}, 800)
			}
			var treeData = [{
				id: 1,
				text: '广州市公安局',
				children: [{
					id: 11,
					text: '越秀分局',
					children: [{
						id: 111,
						text: '北京派出所'
					}]
				}, {
					id: 12,
					text: '天河分局',
					children: [{
						id: 121,
						text: '五山派出所'
					}]
				}, {
					id: 13,
					text: '番禺分局',
					children: [{
						id: 131,
						text: '市桥派出所'
					}]
				}]
			}]
		</script>
	
		<script>
			function createWeek(arrWeek){
				var tableObj = $('<table class="report-table"></table>');
				var thObj = $('<tr></tr>');
				thObj.append('<th></th>');
				var trObj = $('<tr class="report-duty"></tr>');
				trObj.append('<th>值班领导岗位</th>');
				for(var i=0; i<arrWeek.length; i++ ){
					thObj.append('<th class="headerDate">'+arrWeek[i]+'</th>');
					trObj.append('<td class="report-table-policeContainer"><div class="leaderContainer"></div><div class="directorContainer"></div></td>');
				}
				tableObj.append(thObj);
				tableObj.append(trObj);
				return tableObj;
			}
			var currentFirstDate;
			var formatDate = function(date) {              
				var year = date.getFullYear() + '年';        
				var month = (date.getMonth() + 1) + '月';        
				var day = date.getDate() + '日';        
//				var week = '(' + ['星期天', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'][date.getDay()] + ')';         
				var week = ['周天', '周一', '周二', '周三', '周四', '周五', '周六'][date.getDay()];         
//				return year + month + day + ' ' + week;      
				return month + day + ' ' + week;   
			};      
			var addDate = function(date, n) {           
				date.setDate(date.getDate() + n);           
				return date;      
			};      
			var setDate = function(date) {              
				var week = date.getDay() - 1;
				date = addDate(date, week * -1);
				currentFirstDate = new Date(date);
				var arrWeek=[];         
				for(var i = 0; i < 7; i++) {                  
					arrWeek.push(formatDate(i == 0 ? date : addDate(date, 1)));        
				}
				$("#week-container").empty().append(createWeek(arrWeek));  
				bindEvents();        
			};  
			
			
			function prevWeek(){
				setDate(addDate(currentFirstDate,-7));
			}
			function nextWeek(){
				setDate(addDate(currentFirstDate,7));
			}
			
			$(document).ready(function(){
				setDate(new Date());
				
				/*$.ajax({
					type:"post",
					url:"http://192.168.0.138:8080/dic/getDictionaryList.do",
					async:true,
					dataType: 'json',
					data: JSON.stringify({id: "110"},{id: "11055"}),
					contentType:"application/json",
			       	success:function(json){
			        	console.log("提示","成功","info");       
					}
				});*/
			
			})
			
			function onSaveBaoBeiButtonClickHandler(target) {
			/*	layer.open({
					type: 1,
					skin: 'layui-layer-rim', //加上边框
					area: ['1000px', '720px'], //宽高
					content: 'html内容'
				});*/
				layer.open({
					type: 2,
					title: '报备报表',
					shadeClose: true,
					shade: 0.8,
					area: ['80%', '90%'],
					content: 'iframe-saveBaoBei.html' //iframe的url
				});
			}
			function saveBaoBeiInfo(){}
			
			function onMultiBaoBeiButtonClickHandler(target){
//				window.open('multi-leaderReport.html', "值班领导批量报备");
//				parent.iFrame2Page('pages/barrierReport/LeaderReport/multi-leaderReport.html')
				layer.confirm('是否保存当前的报备信息？', {
					btn: ['保存', '不保存', '取消'] //按钮
				}, function() {
					saveBaoBeiInfo();
					$("#week-header").hide();
					$("#month-header").show();
					$("#week-container").hide();
					$("#month-container").show();
					createCalendar();
					layer.closeAll();
				}, function() {
					$("#week-header").hide();
					$("#month-header").show();
					$("#week-container").hide();
					$("#month-container").show();
					createCalendar();
				}, function() {
					layer.closeAll();
				});
				
				
			}
			
			function onBacktoBaoBeiButtonClickHandler(target){
				layer.confirm('是否保存当前的报备信息？', {
					btn: ['保存', '不保存', '取消'] //按钮
				}, function() {
					saveBaoBeiInfo();
					$("#week-header").show();
					$("#month-header").hide();
					$("#week-container").show();
					$("#month-container").hide();
				}, function() {
					$("#week-header").show();
					$("#month-header").hide();
					$("#week-container").show();
					$("#month-container").hide();
				}, function() {
					layer.closeAll();
				});
			}
			
		</script>
	
		<script>
			
			function createCalendar(){
				var calHeight = 700;
				var windowH = $(window).height()
				calHeight = windowH - 180
				if(calHeight < 600) {
					calHeight = 600
				}
				var date = new Date();
				var d = date.getDate(),
					m = date.getMonth(),
					y = date.getFullYear();
				$('#calendar').fullCalendar({
					height: calHeight,
					header: {
						left: 'prev,next today',
						center: 'title',
						right: 'month'
					},
					buttonText: {
						today: '今日',
						month: '月视图',
						week: '周视图',
						day: '日视图'
					},
					eventRender: function(event, element) {
						element.html(event.title);
					},
					events: [],
					dayClick: function(date, allDay, jsEvent, view) {
						$(this).toggleClass('selected');
					}

				});
			}
		</script>
	</body>

</html>